# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  build:
    docker:
        - image: circleci/node:10
    working_directory: ~/grafana-discrete-panel
    steps:
        - checkout
        - run:
            name: Run  Build
            command: |
              npm install
              npm run build
        - persist_to_workspace:
            root: .
            paths:
            - ci

  release:
    docker:
      # specify the version you desire here
      - image: cibuilds/github:0.12

      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/mongo:3.4.4

    working_directory: ~/grafana-discrete-panel

    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: "Publish Release on GitHub"
          command: |
            PLUGIN_NAME=grafana-discrete-panel
            apk add --update --no-cache jq
            VERSION=`cat src/plugin.json|jq '.info.version'| sed s/\"//g`
            ls -al
            git config user.email "rozetko@corpglory.com"
            git config user.name "CircleCI"
            git checkout -b release-${VERSION}
            git add --force dist/
            git commit -m "automated release $VERSION [skip ci]"
            git push -f origin release-${VERSION}
            git tag -f v${VERSION}
            git push -f origin v${VERSION}
            ghr \
              -t ${GITHUB_TOKEN} \
              -u ${CIRCLE_PROJECT_USERNAME} \
              -r ${CIRCLE_PROJECT_REPONAME} \
              -c ${CIRCLE_SHA1} \
              -n "${PLUGIN_NAME} v${VERSION}" \
              -delete \
              v${VERSION}

workflows:
  version: 2
  plugin_workflow:
    jobs:
    - build
    - release:
        requires: build
